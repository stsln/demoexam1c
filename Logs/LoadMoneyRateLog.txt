//http://www.cbr.ru/DailyInfoWebServ/DailyInfo.asmx?WSDL

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	ЗагрузитьКурсыВалют();
	Сообщить("Курсы валют загружены на " + ТекущаяДата());
КонецПроцедуры


Процедура ЗагрузитьКурсыВалют()
    //Создаем прокси для обращения к внешнему веб-сервису,
    // передаем в функцию URI пространства имен, имя сервиса, имя порта.
    Прокси = WSСсылки.КурсыВалютЦБ.СоздатьWSПрокси("http://web.cbr.ru/", "DailyInfo", "DailyInfoSoap12");
    
    //Получаем тип параметра, который передается в метод GetCursOnDate.
    ТипWSПараметра = Прокси.ФабрикаXDTO.Пакеты.Получить("http://web.cbr.ru/").Получить("GetCursOnDate");
    //Создаем параметр на основе типа и заполняем значение параметра On_Date.
    WSПараметр  = Прокси.ФабрикаXDTO.Создать(ТипWSПараметра);
    WSПараметр.On_Date= ТекущаяДата();
    
    //Вызываем метод веб-сервиса, записываем результат в переменную КурсыВалют.
    КурсыВалют = Прокси.GetCursOnDate(WSПараметр);
    
    //Перебираем таблицу ValuteCursOnDate, каждое значение таблицы
    // добавляем в таблицу на форме (колонки заполняем соответствующими значениями).
	Для Каждого Элемент Из КурсыВалют.GetCursOnDateResult.diffgram.ValuteData.ValuteCursOnDate Цикл
		Валюта = СоздатьПолучитьВалюту(Элемент);
		Если Валюта <> Неопределено Тогда 
			МенеджерКурсыВалют = РегистрыСведений.КурсыВалют.СоздатьМенеджерЗаписи();
			МенеджерКурсыВалют.Период = ТекущаяДата();
			МенеджерКурсыВалют.Валюта = Валюта;
        	МенеджерКурсыВалют.Курс = Элемент.Vcurs / Элемент.Vnom;
			МенеджерКурсыВалют.Записать();
		КонецЕсли;
    КонецЦикла;
КонецПроцедуры

&НаСервере
Функция СоздатьПолучитьВалюту(Элемент)
	Валюта = Справочники.Валюты.НайтиПоКоду(Элемент.Vcode);
	
	Если Валюта <> Неопределено И Валюта = Справочники.Валюты.ПустаяСсылка() Тогда
		
		ВалютаОбъект = Справочники.Валюты.СоздатьЭлемент();
		ВалютаОбъект.Наименование = Элемент.Vcurs / Элемент.Vnom;
		ВалютаОбъект.Код = Элемент.Vcode;
		ВалютаОбъект.Записать();
		
		Возврат ВалютаОбъект.Ссылка;
		
	ИначеЕсли ЗначениеЗаполнено(Валюта) Тогда
		
		Возврат Валюта;
		
	Иначе
		
		Возврат Неопределено;
		
	КонецЕсли;	
	
КонецФункции

