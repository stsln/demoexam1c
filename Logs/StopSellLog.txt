//Документ(Сборка)/ МодульОбъекта (С регистром на ОСтаткиНоменклатуры и нужно ещё документ ПриходнаяНакладная)

Процедура ОбработкаПроведения(Отказ, Режим)
	БлокировкаДанных = Новый БлокировкаДанных;
	
	ЭлементБлокировки = БлокировкаДанных.Добавить("РегистрНакопления.ОстаткиНоменклатуры"); 
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	
	ЗапросИсточник = Новый Запрос;
	ЗапросИсточник.Текст =  "ВЫБРАТЬ РАЗЛИЧНЫЕ
	                        |	СборкаКомплектующие.Комплектующее КАК Номенклатура
	                        |ИЗ
	                        |	Документ.Сборка.Комплектующие КАК СборкаКомплектующие
	                        |ГДЕ
	                        |	СборкаКомплектующие.Ссылка = &Ссылка";
	ЗапросИсточник.УстановитьПараметр("Ссылка", Ссылка);
	ИсточникНоменклатуры = ЗапросИсточник.Выполнить();
	
	ЭлементБлокировки.ИсточникДанных = ИсточникНоменклатуры;
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Номенклатура", "Номенклатура");
	БлокировкаДанных.Заблокировать();
	
	Движения.ОстаткиНоменклатуры.Записывать = Истина;
	Для Каждого ТекСтрокаКомплектующие Из Комплектующие Цикл
		Движение = Движения.ОстаткиНоменклатуры.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Номенклатура = ТекСтрокаКомплектующие.Комплектующее;
		Движение.Количество = ТекСтрокаКомплектующие.Количество;
	КонецЦикла;

	Запрос = Новый Запрос;
	Запрос.Текст = 
	               "ВЫБРАТЬ
	               |	ОстаткиНоменклатурыОстатки.Номенклатура КАК Номенклатура,
	               |	ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК КоличествоОстаток
	               |ИЗ
	               |	РегистрНакопления.ОстаткиНоменклатуры.Остатки КАК ОстаткиНоменклатурыОстатки
	               |ГДЕ
	               |	ОстаткиНоменклатурыОстатки.КоличествоОстаток < 0
	               |	И ОстаткиНоменклатурыОстатки.Номенклатура В(&СписокНоменклатуры)";
	
	 Запрос.УстановитьПараметр("СписокНоменклатуры", Комплектующие.ВыгрузитьКолонку("Комплектующее"));
	 Выборка = Запрос.Выполнить().Выбрать();
	 СообщениеПользователю = "";
	 Пока выборка.Следующий() Цикл
		 Отказ = Истина;
		 СообщениеПользователю = СообщениеПользователю + " Не хватает " + Выборка.Номенклатура + " в количестве " +Строка(-Выборка.КоличествоОстаток)+ Символы.ПС; 
	 КонецЦикла;
	 Если Отказ Тогда
	 Сообщить(Лев(СообщениеПользователю,СтрДлина(СообщениеПользователю)-1));
	 КонецЕсли;
КонецПроцедуры